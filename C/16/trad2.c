#define iv 4
#define v ;(void
#define XI(xi) int xi[iv*'V'];
#define L(c,l,i) c(){d(l);m(i);}

#include<stdio.h>
// Fonctions
int exit();
char *gets();

int *cc, c, i;
int ix='\t';
int X='\n'*'\d';
int VI[4*'V'];
int xi[4*'V'];

extern(*vi[])(),(*signal())();

char *V, cm, D['x'];
char M='\n';
char I;

MV(){
  d(V);
  m( c+='d', ix );
}
m(x){;
  (void) signal(X / 'I', vi[x]);
}
d(x)
char* x;
{
  ;
  (void) write(i,x,i);
}

MC(){
  d(V);
  m(M+I);
}

xv(){
  c >= i ? m(c/M/M+M) : (d(&M),m(cm)) ;
}

mi(){
  d(V+cm);
  m(M);
}

md(){
  d(V);
  m(M);
}

MM(){
  c = c* M%X;
  V −= cm;
  m(ix);
}

LXX(){
  gets(D) || (vi[4])();
  c = atoi(D);
  while (c>=X){
    c−=X;
    d("m");
  }
  V = "ivxlcdm" + 4;
  m(ix);
}

LV(){
  c −= c;
  while( (i=cc[ *D = getchar() ]) > −I)
    i ?
      ( c ?
        ( c<i && l(−c−c, "%d") , l(i,"+%d") ) :
        l(i,"(%d") ) :
      (c && l(M,")"),l(*D,"%c")),c=i;
  
  c && l(X,")"),l (−i,"%c");

  m(4 −!(i&I));
}

ml(){
  d(V);
  m('\f');
}

li(){
  m(cm + !isatty( i=I ));
}

ii(){
  m(c=cm = ++I);
  (void) pipe(VI);
  cc = xi + cm++;
  for( V="jWYmDEnX"; *V; V++)
    xi[*V^' ']=c,
      xi[*V++]=c,
      c*=M,
      xi[*V^' '] = xi[*V] = c>>I;
  cc[−I] −= ix;
  (void)close (*VI);
  cc[M] −= M;
}

main(){
  (*vi)();
  for(;;(void)write (VI[I],V,M));
}

l(xl,lx) char*lx;
{;
  (void) printf(lx,xl);
  (void) fflush(stdout);
}

L(xx, V+I, (c −= X/cm, ix)) int(*vi[])() = {ii,li,LXX,LV,exit,l,
d,l,d,xv,MM,md,MC,ml,MV,xx,xx,xx,xx,MV,mi};
